{% extends "!base.html" %}

{%- block extrahead %}
  {{ super() }}
  
  <!-- Sidebar scroll fix - MUST load before Furo's scripts -->
  <script>
    // Override scrollIntoView IMMEDIATELY before any other scripts load
    (function() {
      const originalScrollIntoView = Element.prototype.scrollIntoView;
      
      Element.prototype.scrollIntoView = function(arg) {
        // Check if element or any parent has sidebar-related classes
        let elem = this;
        while (elem) {
          if (elem.classList && (
            elem.classList.contains('sidebar-scroll') ||
            elem.classList.contains('sidebar-tree') ||
            elem.classList.contains('toctree-l1') ||
            elem.classList.contains('toctree-l2') ||
            elem.classList.contains('toctree-l3') ||
            elem.classList.contains('reference') ||
            elem.classList.contains('current')
          )) {
            return; // Don't scroll!
          }
          elem = elem.parentElement;
        }
        
        // For non-sidebar elements, use original behavior
        return originalScrollIntoView.call(this, arg);
      };
      
      // Restore and persist sidebar scroll position across navigation
      document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.querySelector('.sidebar-scroll');
        if (sidebar) {
          // Restore saved position
          const savedPos = parseInt(sessionStorage.getItem('sidebarScrollPosition')) || 0;
          sidebar.scrollTop = savedPos;
          
          // Save position whenever it changes
          sidebar.addEventListener('scroll', function() {
            sessionStorage.setItem('sidebarScrollPosition', sidebar.scrollTop);
          }, { passive: true });
        }
      });
    })();
  </script>
{%- endblock extrahead %}

{%- block scripts %}
  {{ super() }}

   <!-- OSA Chat Widget (HED Assistant)
       Privacy Note: This widget sends page content to an external AI service when
       allowPageContext is enabled. The widget provides contextual help for HEDTools documentation.
       Data sent: Page text content, user questions
       Service: OSA Chat Widget (osa-demo.pages.dev)
  -->
  <script>
    // Define config before the widget script loads
    window.osaChatConfig = {
      communityId: 'hed',
      title: 'HED Assistant',
      initialMessage: 'Questions about HED? Ask me!',
      placeholder: 'Questions about HED?',
      widgetInstructions: 'User is on the integrated HED Tools documentation. Provide helpful answers based on the documentation content. If unsure, say you don\'t know. The individual repositories have their own doc pages which are integrated into this site. Details about using a particular tool will be found in those docs, while general questions are likely to be found in the tutorials on this page.',
      showExperimentalBadge: true,
      allowPageContext: true,
      pageContextDefaultEnabled: true
    };
  </script>
  <script src="https://osa-demo.pages.dev/osa-chat-widget.js"
        crossorigin="anonymous"
        defer
        onload="window.OSAChatWidget && window.OSAChatWidget.setConfig(window.osaChatConfig)"></script>
{%- endblock scripts %}
